<div class="usuarios-container">
  <div class="page-header">
    <h1>Gesti√≥n de Usuarios</h1>
    <p>Administra los usuarios del sistema</p>
    <button (click)="crearUsuario()" class="btn-primary">
      üë• Nuevo Usuario
    </button>
  </div>
  
  <!-- Mensaje de error -->
    @if (error) {
    <div class="error">
        {{ error }}
    </div>
    }

  <!-- Formulario de Usuario -->
    @if (mostrarFormulario) {
    <div class="form-overlay">
        <div class="form-container">
        <div class="form-header">
            <h3>{{ modoEdicion ? 'Editar Usuario' : 'Nuevo Usuario' }}</h3>
            <button (click)="cancelarEdicion()" class="btn-close">√ó</button>
        </div>
        
        <form (ngSubmit)="guardarUsuario()">
            <div class="form-group">
            <label>Nombre:</label>
            <input type="text" 
                    [(ngModel)]="formNombre" 
                    name="formNombre" required>
            </div>

            <div class="form-group">
            <label>Email:</label>
            <input type="email" 
                    [(ngModel)]="formEmail" 
                    name="formEmail" required>
            </div>

            @if (!modoEdicion) {
            <div class="form-group">
                <label>Contrase√±a:</label>
                <input type="password" [(ngModel)]="formPassword" name="formPassword" required>
            </div>

            <div class="form-group">
                <label>Confirmar Contrase√±a:</label>
                <input type="password" [(ngModel)]="formPasswordConfirmation" 
                    name="formPasswordConfirmation" required>
            </div>
            }

            <div class="form-group">
            <label>Rol:</label>
            <select [(ngModel)]="formRol" name="formRol">
                <option value="student">Estudiante</option>
                <option value="admin">Administrador</option>
            </select>
            </div>

            <div class="form-actions">
            <button type="submit" class="btn-primary">
                {{ modoEdicion ? 'Actualizar' : 'Crear' }} Usuario
            </button>
            <button type="button" (click)="cancelarEdicion()" class="btn-secondary">
                Cancelar
            </button>
            </div>
        </form>
        </div>
    </div>
    }

  <!-- Modal de Detalles -->
  @if (mostrarDetalles && usuarioViendo) {
    <div class="modal-overlay">
      <div class="modal-container">
        <div class="modal-header">
          <h3>Detalles del Usuario</h3>
          <button (click)="cancelarEdicion()" class="btn-close">√ó</button>
        </div>
        
        <div class="modal-content">
          <div class="user-details">
            <div class="detail-row">
              <strong>Nombre:</strong>
              <span>{{ usuarioViendo.nombre }}</span>
            </div>
            <div class="detail-row">
              <strong>Email:</strong>
              <span>{{ usuarioViendo.email }}</span>
            </div>
            <div class="detail-row">
              <strong>Rol:</strong>
              <span [class]="'badge ' + usuarioViendo.rol">
                {{ usuarioViendo.rol === 'admin' ? 'Administrador' : 'Estudiante' }}
              </span>
            </div>
            <div class="detail-row">
              <strong>Fecha Registro:</strong>
              <span>{{ formatearFecha(usuarioViendo.created_at) }}</span>
            </div>
            
            @if (usuarioViendo.rol === 'student') {
              <div class="student-details">
                <h4>Estad√≠sticas del Estudiante</h4>
                <div class="detail-row">
                  <strong>Progreso:</strong>
                  <span class="progress-display">
                    <span class="progress-bar">
                      <span class="progress-fill" [style.width.%]="usuarioViendo.progreso || 0"></span>
                    </span>
                    {{ usuarioViendo.progreso || 0 }}%
                  </span>
                </div>
                <div class="detail-row">
                  <strong>Ejercicios Completados:</strong>
                  <span>{{ usuarioViendo.ejercicios_completados || 0 }}</span>
                </div>
                <div class="detail-row">
                  <strong>√öltima Conexi√≥n:</strong>
                  <span>
                    @if (usuarioViendo.ultima_conexion) {
                      {{ formatearFecha(usuarioViendo.ultima_conexion) }} a las 
                      {{ formatearHora(usuarioViendo.ultima_conexion) }}
                    } @else {
                      Nunca
                    }
                  </span>
                </div>
              </div>
            }
          </div>
        </div>
        
        <div class="modal-actions">
          <button (click)="editarUsuario(usuarioViendo!)" class="btn-primary">
            ‚úèÔ∏è Editar Usuario
          </button>
          <button (click)="cancelarEdicion()" class="btn-secondary">
            Cerrar
          </button>
        </div>
      </div>
    </div>
  }

  <!-- Lista de Usuarios -->
  <div class="table-container">
    @if (cargando) {
      <div class="loading">
        <div class="spinner"></div>
        <p>Cargando usuarios...</p>
      </div>
    }

    @if (!cargando && usuarios.length === 0) {
      <div class="empty-state">
        <div class="empty-icon">üë•</div>
        <h3>No hay usuarios registrados</h3>
        <p>Crea el primer usuario del sistema</p>
        <button (click)="crearUsuario()" class="btn-primary">
          Crear Primer Usuario
        </button>
      </div>
    }

    @if (!cargando && usuarios.length > 0) {
      <div class="table-responsive">
        <table class="data-table">
          <thead>
            <tr>
              <th>ID</th>
              <th>Nombre</th>
              <th>Email</th>
              <th>Rol</th>
              <th>Progreso</th>
              <th>√öltima Conexi√≥n</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody>
            @for (usuario of usuarios; track usuario.id) {
              <tr>
                <td>{{ usuario.id }}</td>
                <td class="user-name">{{ usuario.nombre }}</td>
                <td>{{ usuario.email }}</td>
                <td>
                  <span [class]="'badge ' + usuario.rol">
                    {{ usuario.rol === 'admin' ? 'Administrador' : 'Estudiante' }}
                  </span>
                </td>
                <td>
                  @if (usuario.rol === 'student') {
                    <div class="progress-cell">
                      <span class="progress-text">{{ usuario.progreso || 0 }}%</span>
                      <div class="progress-bar-small">
                        <div class="progress-fill" [style.width.%]="usuario.progreso || 0"></div>
                      </div>
                    </div>
                  } @else {
                    <span class="text-muted">-</span>
                  }
                </td>
                <td>
                  @if (usuario.ultima_conexion) {
                    {{ formatearFecha(usuario.ultima_conexion) }}
                  } @else {
                    <span class="text-muted">Nunca</span>
                  }
                </td>
                <td class="actions">
                  <button (click)="verDetalles(usuario)" class="btn-view" title="Ver detalles">
                    üëÅÔ∏è
                  </button>
                  <button (click)="editarUsuario(usuario)" class="btn-edit" title="Editar">
                    ‚úèÔ∏è
                  </button>
                  <button (click)="eliminarUsuario(usuario)" class="btn-delete" title="Eliminar">
                    üóëÔ∏è
                  </button>
                </td>
              </tr>
            }
          </tbody>
        </table>
      </div>
    }
  </div>
</div>